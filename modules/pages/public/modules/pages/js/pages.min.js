var current_id="",folders_edit_dlg=$.UIkit.modal("#taracot_pages_folders_edit_dlg"),folders_select_dlg=$.UIkit.modal("#taracot_pages_folders_select_dlg"),folders_edit=!1,jstree_folders,jstree_folders_select,folders_data,root_pages=[],current_folder="",ckeditor,process_rows=[function(a,b){return'<label id="taracot-table-lbl-'+b+'"><input type="checkbox" class="taracot-table-chbx" id="taracot-table-chbx-'+b+'" rel="taracot-item_'+a+'"></div>&nbsp;'+a+"</label>"},function(a){return null===a&&(a="&mdash;"),a},function(a){return'<div style="text-align:center">'+a+"</div>"},function(a,b){return'<div style="text-align:center;width:100px"><button class="uk-icon-button uk-icon-edit taracot-tableitem-edit" id="taracot-btnedt-'+b+'" type="button"></button>&nbsp;<button class="uk-icon-button uk-icon-button-danger uk-icon-trash-o taracot-tableitem-delete" id="taracot-btndel-'+b+'" type="button"></button></div>'}];$("#btn-select-all").click(function(){$(".taracot-table-chbx").prop("checked",!0)}),$("#btn-select-none").click(function(){$(".taracot-table-chbx").prop("checked",!1)}),$("#btn-delete-selected").click(function(){var a=[];$(".taracot-table-chbx").each(function(b,c){$(c).prop("checked")&&a.push($(c).attr("id").replace("taracot-table-chbx-",""))}),a.length>0&&delete_item(a)});var show_folders=function(){$("#taracot_pages_list").addClass("uk-hidden"),$("#taracot_pages_folders").removeClass("uk-hidden"),$("#taracot_pages_edit").addClass("uk-hidden"),btn_folders_click_handler()},show_pages=function(){push_state({mode:"pages"},"?mode=pages"),$("#taracot_pages_list").removeClass("uk-hidden"),$("#taracot_pages_folders").addClass("uk-hidden"),$("#taracot_pages_edit").addClass("uk-hidden")},btn_add_item_handler=function(){current_id="",root_pages=[],current_folder="",$("#taracot_pages_edit_action").html(_lang_vars.action_add),$("#taracot_pages_list").addClass("uk-hidden"),$("#taracot_pages_edit").removeClass("uk-hidden"),$(".taracot-page-edit-form-control").each(function(){$(this).val(""),$(this).removeClass("uk-form-danger")}),$("#pcontent").val(""),$("#plang").val(locales[0]),$("#playout").val(layouts.default),$("#pfolder").val("/"),$("#plangcopy_row").removeClass("uk-hidden"),$("#plangcopy").attr("checked",!1),$("#taracot-pagetype-regular > a").click(),taracot_ajax_progress_indicator("body",!0),ckeditor||init_ckeditor(),$.ajax({type:"POST",url:"/cp/pages/data/rootpages",dataType:"json",success:function(a){taracot_ajax_progress_indicator("body",!1),a&&a.status&&1==a.status&&a.root_pages&&(root_pages=a.root_pages,$("#pfolder").change()),$("#ptitle").focus()},error:function(){$("#ptitle").focus()}})};$("#btn-add-item").click(function(){push_state({mode:"add_page"},"?mode=add_page"),btn_add_item_handler()});var edit_item=function(a){push_state({mode:"edit_page",current_id:a},"?mode=edit_page"),current_id=a,current_folder="",$("#taracot_pages_edit_action").html(_lang_vars.action_edit),$("#plangcopy_row").addClass("uk-hidden"),$("#playout").val(layouts.default),$(".taracot-page-edit-form-control").each(function(){$(this).val("")}),taracot_ajax_progress_indicator("body",!0),$.ajax({type:"POST",url:"/cp/pages/data/load",dataType:"json",data:{pid:current_id},success:function(a){if(taracot_ajax_progress_indicator("body",!1),1==a.status)ckeditor||init_ckeditor(),$("#taracot_pages_list").addClass("uk-hidden"),$("#taracot_pages_edit").removeClass("uk-hidden"),$("#taracot_pages_edit").show(),a.root_pages&&(root_pages=a.root_pages),a.data&&(a=a.data),a.ptitle&&$("#ptitle").val(a.ptitle),a.pfilename&&a.pfilename.length?($("#pfilename").val(a.pfilename),$("#taracot-pagetype-regular > a").click()):$("#taracot-pagetype-root > a").click(),a.pfolder&&($("#pfolder").val(a.pfolder),current_folder=a.pfolder),a.pfolder_id&&$("#pfolder_id").val(a.pfolder_id),a.plang&&$("#plang").val(a.plang),a.playout&&$("#playout").val(a.playout),a.pkeywords&&$("#pkeywords").val(a.pkeywords),a.pdesc&&$("#pdesc").val(a.pdesc),$("#pcontent").val(a.pcontent?a.pcontent:""),$("#pfolder").change();else{var b=_lang_vars.ajax_failed;a.error&&(b=a.error),$.UIkit.notify({message:b,status:"danger",timeout:2e3,pos:"top-center"})}},error:function(){taracot_ajax_progress_indicator("body",!1),$.UIkit.notify({message:_lang_vars.ajax_failed,status:"danger",timeout:2e3,pos:"top-center"})}})},delete_item=function(a){for(var b=[],c=0;c<a.length;c++)b.push($("#taracot-table-chbx-"+a[c]).attr("rel").replace("taracot-item_",""));confirm(_lang_vars.del_confirm+"\n\n"+b.join(", "))&&($("#taracot_table").medvedTable("loading_indicator_show"),$.ajax({type:"POST",url:"/cp/pages/data/delete",data:{ids:a},dataType:"json",success:function(a){$("#taracot_table").medvedTable("loading_indicator_hide"),1==a.status?$("#taracot_table").medvedTable("update"):$.UIkit.notify({message:_lang_vars.delete_err_msg,status:"danger",timeout:2e3,pos:"top-center"})},error:function(){$("#taracot_table").medvedTable("loading_indicator_hide"),$.UIkit.notify({message:_lang_vars.delete_err_msg,status:"danger",timeout:2e3,pos:"top-center"})}}))};$("#btn_edit_save").click(function(){$(".taracot-page-edit-form-control").each(function(){$(this).removeClass("uk-form-danger")});var a=$.trim($("#ptitle").val()),b=$.trim($("#pfilename").val()),c=$.trim($("#pfolder").val()),d=$("#pfolder_id").val();d||(d=jstree_get_root_id());var e=$("#plang").val(),f=$("#playout").val(),g=!1;$("#plangcopy").attr("checked")&&(g=!0);var h,i=$.trim($("#pkeywords").val()),j=$.trim($("#pdesc").val()),k=!1;return(!a||!a.length||a.length>100)&&($("#ptitle").addClass("uk-form-danger"),k=!0,h||(h="#ptitle")),$("#taracot-pagetype-root").hasClass("uk-active")?b="":b.match(/^[A-Za-z0-9_\-\.]{1,80}$/)||($("#pfilename").addClass("uk-form-danger"),k=!0,h||(h="#pfilename")),k?($.UIkit.notify({message:_lang_vars.form_contain_errors,status:"danger",timeout:2e3,pos:"top-center"}),void(h&&$(h).focus())):(taracot_ajax_progress_indicator("body",!0),void $.ajax({type:"POST",url:"/cp/pages/data/save",dataType:"json",data:{pid:current_id,ptitle:a,pfilename:b,pfolder:c,pfolder_id:d,plang:e,plangcopy:g,playout:f,pkeywords:i,pdesc:j,pcontent:$("#pcontent").val()},success:function(a){if(taracot_ajax_progress_indicator("body",!1),1==a.status)$.UIkit.notify({message:_lang_vars.page_save_success,status:"success",timeout:2e3,pos:"top-center"}),show_pages(),$("#taracot_table").medvedTable("update");else{var b=_lang_vars.ajax_failed;a.error&&(b=a.error),$.UIkit.notify({message:b,status:"danger",timeout:2e3,pos:"top-center"})}},error:function(){taracot_ajax_progress_indicator("body",!1),$.UIkit.notify({message:_lang_vars.ajax_failed,status:"danger",timeout:2e3,pos:"top-center"})}}))}),$(".taracot-page-edit-form-control").bind("keypress",function(a){submitOnEnter(a)&&$("#btn_edit_save").click()}),$("#btn_edit_cancel").click(function(){confirm(_lang_vars.confirm_page_edit_cancel)&&show_pages()}),$("#btn-parts").click(function(){open_parts_window()}),$("#pfolder").change(function(){$("#taracot-pagetype-root").removeClass("uk-hidden");for(var a=0;a<root_pages.length;a++)$("#pfolder").val()==root_pages[a]&&""!==$("#pfilename").val()&&($("#taracot-pagetype-regular > a").click(),$("#taracot-pagetype-root").addClass("uk-hidden")),$("#pfolder").val()==current_folder&&($("#pfilename").val().length||$("#taracot-pagetype-root > a").click()),""===current_folder&&$("#pfolder").val()==root_pages[a]&&($("#taracot-pagetype-regular > a").click(),$("#taracot-pagetype-root").addClass("uk-hidden"))}),$(document).ready(function(){$("#taracot_table").medvedTable({col_count:4,sort_mode:1,sort_cell:"pfolder",taracot_table_url:"/cp/pages/data/list",process_rows:process_rows}),$("#pfolder").attr("readonly",!0),folders_data=folders_preload,bind_history(),history_handler(),init_ckeditor()});var bind_history=function(){History.Adapter.bind(window,"statechange",function(){history_handler()})},_history_handler_disable=!1,history_handler=function(){if(!_history_handler_disable){var a=History.getState();if(a.data.mode)switch(a.data.mode){case"pages":show_pages();break;case"folders":show_folders();break;case"add_page":btn_add_item_handler();break;case"edit_page":edit_item(a.data.current_id)}else push_state({mode:"pages"},"?mode=pages")}},push_state=function(a,b){_history_handler_disable=!0,History.pushState(a,_lang_vars.control_panel,b),_history_handler_disable=!1},init_ckeditor=function(){ckeditor=$("#pcontent").ckeditor({filebrowserBrowseUrl:"/cp/browse",filebrowserImageBrowseUrl:"/cp/browse?io=1",filebrowserWindowWidth:800,filebrowserWindowHeight:500,allowedContent:!0}).editor},taracot_ajax_progress_indicator=function(a,b){if(b){var c=$(a).offset();$(".taracot-progress").css({top:c.top,left:c.left,width:$(a).width(),height:$(a).height()}),$(".taracot-progress").removeClass("uk-hidden")}else $(".taracot-progress").addClass("uk-hidden")},open_parts_window=function(){var a=parseInt(screen.width/1.5),b=500,c=parseInt(screen.width/2-a/2),d=parseInt(screen.height/2-b/2);window.open("/cp/parts","","toolbar=no, location=0, status=no, titlebar=no, menubar=no, width="+a+", height="+b+", top="+d+", left="+c)},btn_folders_click_handler=function(){$("#jstree_folders").addClass("uk-hidden"),$("#jstree_error").addClass("uk-hidden"),$("#jstree_loading").removeClass("uk-hidden"),$(".taracot-tree-save-controls").attr("disabled",!0),$(".taracot-treectl-button").attr("disabled",!0),$.ajax({type:"POST",url:"/cp/pages/data/folders/load",dataType:"json",success:function(a){if(1==a.status)$("#jstree_folders").removeClass("uk-hidden"),$("#jstree_error").addClass("uk-hidden"),$("#jstree_loading").addClass("uk-hidden"),$(".taracot-tree-save-controls").attr("disabled",!1),$("#btn-tree-new").attr("disabled",!1),a.folders&&init_jstree(jQuery.parseJSON(a.folders));else{var b=_lang_vars.ajax_failed;a.error&&(b=a.error),$.UIkit.notify({message:b,status:"danger",timeout:2e3,pos:"top-center"}),$("#btn-tree-cancel").attr("disabled",!1),$("#jstree_loading").addClass("uk-hidden"),$("#jstree_error").html(b),$("#jstree_error").removeClass("uk-hidden")}},error:function(){$.UIkit.notify({message:_lang_vars.ajax_failed,status:"danger",timeout:2e3,pos:"top-center"}),$("#btn-tree-cancel").attr("disabled",!1),$("#jstree_loading").addClass("uk-hidden"),$("#jstree_error").html(_lang_vars.ajax_failed),$("#jstree_error").removeClass("uk-hidden")}})};$("#btn-folders").click(function(){push_state({mode:"folders"},"?mode=folders"),show_folders()}),$("#btn-tree-new").click(function(){$("#fname").removeClass("uk-form-danger");var a=jstree_folders.jstree(!0).get_selected();a&&a.length&&($("#taracot_pages_folders_edit_h1").html(_lang_vars.new_folder),$(".taracot-folders-edit-control").each(function(){$(this).val("")}),folders_edit=!1,folders_edit_dlg.show(),$("#fname").focus())}),$("#btn-tree-edit").click(function(){$("#fname").removeClass("uk-form-danger");var a=jstree_folders.jstree(!0).get_selected();if(a&&a.length&&"#"!=jstree_folders.jstree(!0).get_parent(a)){$("#taracot_pages_folders_edit_h1").html(_lang_vars.edit_folder),$(".taracot-folders-edit-control").each(function(){$(this).val("")});for(var b=0;b<locales.length;b++)$("#flang_"+locales[b]).val(jstree_folders.jstree(!0).get_node(a).data.lang[locales[b]]);$("#fname").val(jstree_folders.jstree(!0).get_node(a).text),folders_edit=!0,folders_edit_dlg.show(),$("#fname").select(),$("#fname").focus()}}),$("#btn-tree-save").click(function(){$("#jstree_folders").addClass("uk-hidden"),$("#jstree_error").addClass("uk-hidden"),$("#jstree_loading").removeClass("uk-hidden"),$(".taracot-tree-save-controls").attr("disabled",!0),$(".taracot-treectl-button").attr("disabled",!0);for(var a=jstree_folders.jstree(!0).get_json(jstree_folders,{flat:!0,no_state:!0,no_id:!1,no_data:!1}),b=0;b<a.length;b++)delete a[b].li_attr,delete a[b].a_attr,delete a[b].icon,delete a[b].state;$.ajax({type:"POST",url:"/cp/pages/data/folders/save",dataType:"json",data:{json:JSON.stringify(a)},success:function(b){if($("#jstree_folders").removeClass("uk-hidden"),$("#jstree_error").addClass("uk-hidden"),$("#jstree_loading").addClass("uk-hidden"),$(".taracot-tree-save-controls").attr("disabled",!1),$(".taracot-treectl-button").attr("disabled",!1),jstree_folders.jstree(!0).deselect_all(),jstree_find_root(),1==b.status)folders_data=a,$.UIkit.notify({message:_lang_vars.folders_save_success,status:"success",timeout:2e3,pos:"top-center"}),show_pages();else{var c=_lang_vars.ajax_failed;b.error&&(c=b.error),$.UIkit.notify({message:c,status:"danger",timeout:2e3,pos:"top-center"})}},error:function(){$.UIkit.notify({message:_lang_vars.ajax_failed,status:"danger",timeout:2e3,pos:"top-center"}),$("#jstree_folders").removeClass("uk-hidden"),$("#jstree_error").addClass("uk-hidden"),$("#jstree_loading").addClass("uk-hidden"),$(".taracot-tree-save-controls").attr("disabled",!1),$("#btn-tree-new").attr("disabled",!1),jstree_folders.jstree(!0).deselect_all(),jstree_find_root()}})}),$("#btn-tree-cancel").click(function(){confirm(_lang_vars.confirm_folders_edit_cancel)&&show_pages()}),$("#btn-tree-clear").click(function(){confirm(_lang_vars.confirm_folders_edit_clean)&&init_jstree([],!0)}),$("#btn-tree-delete").click(function(){var a=jstree_folders.jstree(!0).get_selected();if(a&&a.length){for(var b="",c=0;c<a.length;c++)b+=", "+jstree_folders.jstree(!0).get_node(a[c]).text;confirm(_lang_vars.confirm_delete_tree+"\n\n"+b.replace(/,/,""))&&jstree_folders.jstree(!0).delete_node(a)}}),$(".taracot-folders-edit-control").bind("keypress",function(a){submitOnEnter(a)&&$("#btn_folders_edit_save").click()}),$("#btn_folders_edit_save").click(function(){$("#fname").removeClass("uk-form-danger");var a=jstree_folders.jstree(!0).get_selected();if(a&&a.length&&!(a.length>1)){if(!check_directory($("#fname").val()))return $("#fname").addClass("uk-form-danger"),void $.UIkit.notify({message:_lang_vars.invalid_folder,status:"danger",timeout:2e3,pos:"top-center"});if(folders_edit){jstree_folders.jstree(!0).rename_node(a,$("#fname").val()),jstree_folders.jstree(!0).get_node(a).data={},jstree_folders.jstree(!0).get_node(a).data.lang={};for(var b=0;b<locales.length;b++)jstree_folders.jstree(!0).get_node(a).data.lang[locales[b]]=$("#flang_"+locales[b]).val()}else{var c=jstree_folders.jstree(!0).create_node(a,{text:$("#fname").val(),type:"folder"});c||($("#fname").addClass("uk-form-danger"),$.UIkit.notify({message:_lang_vars.duplicate_folder,status:"danger",timeout:2e3,pos:"top-center"})),jstree_folders.jstree(!0).get_node(c).data={},jstree_folders.jstree(!0).get_node(c).data.lang={};for(var d=0;d<locales.length;d++)jstree_folders.jstree(!0).get_node(c).data.lang[locales[d]]=$("#flang_"+locales[d]).val();jstree_folders.jstree(!0).open_node(a)}folders_edit_dlg.hide()}});var init_jstree=function(a){jstree_folders&&jstree_folders.jstree(!0).destroy(),jstree_folders=$("#jstree_folders").jstree({core:{check_callback:!0,data:a},plugins:["dnd","unique","types"],types:{"#":{max_children:1,valid_children:["root"]},root:{valid_children:["folder"]},folder:{valid_children:["folder"]}}}),jstree_folders.on("loaded.jstree",function(){jstree_folders.jstree(!0).open_all("#"),jstree_find_root()}),jstree_folders.on("changed.jstree",function(a,b){jstree_changed_handler(a,b)})},jstree_find_root=function(){for(var a=jstree_folders.jstree(!0).get_json(jstree_folders,{flat:!0,no_state:!0,no_id:!1,no_data:!1}),b=0;b<a.length;b++)"#"==a[b].parent&&jstree_folders.jstree(!0).select_node(a[b].id)},jstree_get_root_id=function(){for(var a=0;a<folders_data.length;a++)if("#"==folders_data[a].parent)return folders_data[a].id;return""},jstree_insert_root=function(){var a=jstree_folders.jstree(!0).create_node("#",{text:"/",type:"root"});jstree_folders.jstree(!0).select_node(a)},init_jstree_select=function(){jstree_folders_select&&jstree_folders_select.jstree(!0).destroy(),jstree_folders_select=$("#jstree_folders_select").jstree({core:{check_callback:!0,data:folders_data},plugins:["dnd","unique","types"],types:{"#":{max_children:1,valid_children:["root"]},root:{valid_children:["folder"]},folder:{valid_children:["folder"]}}}),jstree_folders_select.on("loaded.jstree",function(){jstree_folders_select.jstree(!0).open_all("#")}),jstree_folders_select.on("changed.jstree",function(a,b){!b.selected.length||b.selected.length>1?$("#btn_folders_select").attr("disabled",!0):$("#btn_folders_select").attr("disabled",!1)})},jstree_changed_handler=function(a,b){b.selected.length?$(".taracot-treectl-button").attr("disabled",!1):$(".taracot-treectl-button").attr("disabled",!0);for(var c=0;c<b.selected.length;c++)"#"==jstree_folders.jstree(!0).get_parent(b.selected[c])&&$(".taracot-treectl-button").attr("disabled",!0),$("#btn-tree-new").attr("disabled",!1);b.selected.length>1&&($("#btn-tree-new").attr("disabled",!0),$("#btn-tree-edit").attr("disabled",!0))};$("#btn-select-folder").click(function(){init_jstree_select(),folders_select_dlg.show(),$("#btn_folders_select").attr("disabled",!0)}),$("#btn_folders_select").click(function(){var a=jstree_folders_select.jstree(!0).get_selected();if(a&&a.length&&!(a.length>1)){var b=jstree_folders_select.jstree(!0).get_path(a).join("/").replace(/\//,"");b||(b="/"),$("#pfolder").val(b),$("#pfolder_id").val(a),folders_select_dlg.hide(),$("#pfolder").change()}});var check_directory=function(a){return!a||!a.length||a.length>40?!1:a.match(/^\./)?!1:a.match(/^\\/)?!1:a.match(/ /)?!1:a.match(/^[\^<>\/\:\"\\\|\?\*\x00-\x1f]+$/)?!1:!0};