var async = require('async');
var prompt = require('prompt');
var crypto = require('crypto');
var config = require('../config');
var mongoclient = require('mongodb').MongoClient;
var fs = require('fs');
var db;
prompt.message = "> ".green;
prompt.delimiter = "";
prompt.start();

function generateId(lngth) {
	if (!lngth) {
		lngth = 16;
	}
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for( var i=0; i < lngth; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    return text;
}

async.series([
		function (callback) {
			console.log("This script will guide you with TaracotJS basic installation steps.\n");
			console.log("Database connection is required.");
			console.log("Current MongoDB URL: " + config.mongo.url + "\n");
			prompt.get(['Continue? y/n'], function (err, result) {
				if (!err && result && 'Continue? y/n' in result && result['Continue? y/n'] == 'y') {
					callback();
				} else {
					console.log("\n\nAborted");
					process.exit(code = 0);
				}
			});
		},
		function (callback) {
			mongoclient.connect(config.mongo.url, config.mongo_options, function (err, _db) {
				if (err) {
					console.log("\nCould not connect to the MongoDB. Please check config.js");
					console.log(err);
					process.exit(1);
				}
				console.log("\nConnected to MongoDB\n");
				db = _db;
				callback();
			});
		},
		function (callback) {
			prompt.get(['Generate secrets and salt? y/n'], function (err, result) {
				if (!err && result && 'Generate secrets and salt? y/n' in result && result['Generate secrets and salt? y/n'] == 'y') {
					config.cookie_secret = generateId(32);
					config.session_secret = generateId(32);
					config.salt = generateId(64);
					fs.writeFile('../config.js', 'var config = ' + JSON.stringify(config, null, "\t") + ";\n\nmodule.exports = config;", function (err) {
						if (err) {
							console.log("\nCould not save config.js file. Check your permissions");
							console.log(err);
							process.exit(1);
						}
						console.log("... success");
						callback();
					});
				} else {
					console.log("\nNote: it's important to set these values for security purposes!");
					callback();
				}
			});
		},
		function (callback) {
			console.log("\nCreating collection: users\n");
			db.createCollection('users', function (err, collection) {
				if (err) {
					console.log("... failed");
					console.log(err);
					process.exit(1);
				}
				console.log("... success");
				callback();
			});
		},
		function (callback) {
			db.collection('users').remove( { username : 'admin' }, function () {
				callback();
			});
		},
		function (callback) {
			console.log("\nCreating default user account\n");
			var md5 = crypto.createHash('md5');
			var password_md5 = md5.update(config.salt + '.admin').digest('hex');			
			db.collection('users').insert({
					username: 'admin',
					email: 'default@taracot.org',
					realname: 'Website Administrator',
					status: 2,
					password: password_md5
				}, function (err) {
					if (err) {
						console.log("... failed");
						console.log(err);
						process.exit(1);
					}
					console.log("... success");
					callback();
				});
		},
		function (callback) {
			console.log("\nCreating indexes for collection: users\n");
			ensure_indexes('users', ['username', 'email', 'realname', 'status']);
			console.log("... success");
			callback();
		},		
		function (callback) {
			console.log("\nCreating collection: settings\n");
			db.createCollection('settings', function (err, collection) {
				if (err) {
					console.log("... failed");
					console.log(err);
					process.exit(1);
				}
				console.log("... success");
				callback();
			});
		},
		function (callback) {
			console.log("\nAdding default setting (site_title)...\n");
			db.collection('settings').insert({
					oname: 'site_title',
					ovalue: 'Taracot JS',
					olang: 'en'
				}, function (err) {
					if (err) {
						console.log("... failed");
						console.log(err);
						process.exit(1);
					}
					console.log("... success");
					callback();
				});
		},
		function (callback) {
			console.log("\nCreating indexes for collection: settings\n");
			ensure_indexes('settings', ['oname', 'ovalue', 'olang']);
			console.log("... success");
			callback();
		},
		function (callback) {
			console.log("\nCreating collection: pages\n");
			db.createCollection('pages', function (err, collection) {
				if (err) {
					console.log("... failed");
					console.log(err);
					process.exit(1);
				}
				console.log("... success");
				callback();
			});
		},
		function (callback) {
			console.log("\nAdding default page...\n");
			db.collection('pages').insert({
					ptitle: 'Default page',
					pfolder: '/',
					pfilename: '',
					plang: 'en',
					playout: config.layouts.default,
					pfolder_id: 'j1_1',
					pkeywords: 'sample, keywords, here',
					pdesc: 'This is the sample page',
					pcontent: 'As you see this, the installation seems to be completed ;-)'
				}, function (err) {
					if (err) {
						console.log("... failed");
						console.log(err);
						process.exit(1);
					}
					console.log("... success");
					callback();
				});
		},
		function (callback) {
			console.log("\nCreating indexes for collection: pages\n");
			ensure_indexes('pages', ['pfolder', 'pfilename', 'plang', 'ptitle']);
			console.log("... success");
			callback();
		},
		function (callback) {
			console.log("\nCreating collection: pages_folders\n");
			db.createCollection('pages_folders', function (err, collection) {
				if (err) {
					console.log("... failed");
					console.log(err);
					process.exit(1);
				}
				console.log("... success");
				callback();
			});
		},
		function (callback) {
			console.log("\nAdding default folder tree for pages module...\n");
			db.collection('pages_folders').insert({
					oname: 'folders_json',
					ovalue: '[{"id":"j1_1","text":"/","data":null,"parent":"#","type":"root"}]'
				}, function (err) {
					if (err) {
						console.log("... failed");
						console.log(err);
						process.exit(1);
					}
					console.log("... success");
					callback();
				});
		},
		function (callback) {
			console.log("\nCreating indexes for collection: pages_folders\n");
			ensure_indexes('pages_folders', ['oname', 'ovalue']);
			console.log("... success");
			callback();
		},
		function (callback) {
			console.log("\nCreating collection: menu\n");
			db.createCollection('pages_folders', function (err, collection) {
				if (err) {
					console.log("... failed");
					console.log(err);
					process.exit(1);
				}
				console.log("... success");
				callback();
			});
		}
	],
	function (err) {
		if (err) {
			console.log("\nInstallation failed");
			console.log(err);
			process.exit(1);
		}
		console.log("\nFinished");
		process.exit(code = 0);
	}
);

/*

 Helper functions

*/

function ensure_indexes(col, ia, _opt, ow) {
	var opt = {
				unique: false,
				background: true,
				dropDups: false,
				w: 1 
			  };
	if (_opt) opt = _opt;
	for (var i=0; i<ia.length; ia++) {
		var i1 = {};
		i[ia[i]] = 1;
		var i2 = {};
		i[ia[i]] = -1;
		db.ensureIndex(col, i1, opt, function(err) {});
		if (!ow) {
			db.ensureIndex(col, i2, opt, function(err) {});
		}
	}
}